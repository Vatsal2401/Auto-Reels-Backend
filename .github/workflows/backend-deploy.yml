name: Backend Deployment

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      # Load SSH key correctly (bulletproof)
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}

      # ðŸ”Ž TEMP DEBUG â€” remove after success
      - name: Debug secrets presence
        run: |
          echo "HOST=${{ secrets.GCP_VM_HOST }}"
          echo "USER=${{ secrets.GCP_VM_USER }}"

      - name: Ensure target directory exists
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_HOST }} \
            "mkdir -p /home/${{ secrets.GCP_VM_USER }}/backend-infra/auto-reels-backend"

      - name: Copy build to VM
        run: |
          scp -o StrictHostKeyChecking=no -r \
            dist package.json package-lock.json \
            ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_HOST }}:/home/${{ secrets.GCP_VM_USER }}/backend-infra/auto-reels-backend

      - name: Deploy and restart
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_HOST }} << 'EOF'
              cd /home/${{ secrets.GCP_VM_USER }}/backend-infra/auto-reels-backend
              echo "${{ secrets.BACKEND_ENV }}" > .env
              npm ci --omit=dev
              pm2 restart backend-api || pm2 start dist/main.js --name backend-api
              pm2 save
          EOF
